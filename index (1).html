<!DOCTYPE html>

<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#2C4A7C">
<link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŒ¸</text></svg>">
<title>Meu Ciclo - MOB</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{--blue:#2C4A7C;--blue2:#3B5998;--blue-light:#E8EEF6;--blue-bg:#F0F4F9;--green:#4CAF50;--green2:#388E3C;--yellow:#FFC107;--yellow2:#F9A825;--red:#E53935;--red2:#C62828;--white-stamp:#ECEFF1;--text:#2D3748;--text2:#64748B;--border:#D4DBE8;--bg:#F5F7FB}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,sans-serif;background:var(--bg);min-height:100vh;max-width:500px;margin:0 auto;color:var(--text);position:relative;overflow-x:hidden}
button{font-family:inherit;cursor:pointer;-webkit-appearance:none;appearance:none}
select,textarea{font-family:inherit;-webkit-appearance:none;appearance:none}

/* NAV BAR */
.navbar{background:var(--blue);color:#fff;padding:16px 20px;position:sticky;top:0;z-index:10;display:-webkit-flex;display:flex;-webkit-align-items:center;align-items:center;-webkit-justify-content:space-between;justify-content:space-between}
.navbar h1{font-size:20px;font-weight:700;letter-spacing:-0.3px}
.navbar .nav-right{display:-webkit-flex;display:flex;gap:12px;-webkit-align-items:center;align-items:center}
.nav-icon{background:none;border:none;color:#fff;font-size:18px;padding:4px}

/* TABS */
.tabs{display:-webkit-flex;display:flex;background:#fff;border-bottom:1px solid var(--border);position:sticky;top:56px;z-index:9}
.tab{-webkit-flex:1;flex:1;padding:12px 8px;border:none;background:none;font-size:13px;font-weight:600;color:var(--text2);border-bottom:3px solid transparent;transition:all 0.2s}
.tab.on{color:var(--blue);border-bottom-color:var(--blue)}

/* HOME */
.home-card{margin:16px;background:var(--blue);border-radius:16px;padding:20px;color:#fff;display:-webkit-flex;display:flex;-webkit-align-items:center;align-items:center;-webkit-justify-content:space-between;justify-content:space-between;box-shadow:0 4px 16px rgba(44,74,124,0.25)}
.home-card .hc-text h2{font-size:18px;font-weight:700;margin-bottom:4px}
.home-card .hc-text p{font-size:13px;opacity:0.85}
.home-card .hc-btn{width:52px;height:52px;border-radius:50%;background:rgba(255,255,255,0.2);border:2px solid rgba(255,255,255,0.5);color:#fff;font-size:28px;display:-webkit-flex;display:flex;-webkit-align-items:center;align-items:center;-webkit-justify-content:center;justify-content:center;-webkit-flex-shrink:0;flex-shrink:0}

.info-row{margin:0 16px 12px;padding:14px 16px;background:#fff;border-radius:12px;border:1px solid var(--border);display:-webkit-flex;display:flex;-webkit-align-items:center;align-items:center;gap:10px}
.info-row .dot{width:10px;height:10px;border-radius:50%;-webkit-flex-shrink:0;flex-shrink:0}
.info-row .ir-label{font-size:14px;font-weight:600}
.info-row .ir-val{font-size:13px;color:var(--text2);margin-left:auto}

/* CALENDAR */
.cal-wrap{padding:12px 16px}
.mnav{display:-webkit-flex;display:flex;-webkit-align-items:center;align-items:center;-webkit-justify-content:space-between;justify-content:space-between;margin-bottom:12px}
.mnav h2{font-size:17px;font-weight:700;color:var(--blue)}
.nbtn{width:34px;height:34px;border-radius:10px;border:1px solid var(--border);background:#fff;font-size:18px;color:var(--blue);font-weight:700;display:-webkit-flex;display:flex;-webkit-align-items:center;align-items:center;-webkit-justify-content:center;justify-content:center}
.wk{display:grid;grid-template-columns:repeat(7,1fr);gap:2px;margin-bottom:4px}
.wk span{text-align:center;font-size:10px;font-weight:700;color:var(--text2);padding:4px 0;text-transform:uppercase;letter-spacing:0.5px}
.cg{display:grid;grid-template-columns:repeat(7,1fr);gap:3px}
.cc{position:relative;border:none;border-radius:10px;background:#fff;display:-webkit-flex;display:flex;-webkit-flex-direction:column;flex-direction:column;-webkit-align-items:center;align-items:center;-webkit-justify-content:center;justify-content:center;padding:4px 2px;min-height:50px;box-shadow:0 1px 2px rgba(0,0,0,0.05);font-size:12px;font-weight:600;gap:2px}
.cc .day-num{color:var(--text)}
.cc.today-c .day-num{color:var(--blue);font-weight:800}
.cc .stamp{width:22px;height:22px;border-radius:4px;display:-webkit-flex;display:flex;-webkit-align-items:center;align-items:center;-webkit-justify-content:center;justify-content:center;font-size:9px;font-weight:800;color:#fff}
.cc .stamp.sm-red{background:var(--red)}
.cc .stamp.sm-red2{background:var(--red);position:relative}
.cc .stamp.sm-red2::after{content:"";position:absolute;width:4px;height:4px;border-radius:50%;background:#fff;top:3px;right:3px}
.cc .stamp.sm-yellow{background:var(--yellow)}
.cc .stamp.sm-green{background:var(--green)}
.cc .stamp.sm-green-peak{background:var(--green);border:2px solid var(--green2)}
.cc .stamp.sm-white{background:var(--white-stamp);border:1px solid #ccc}
.cc .stamp.sm-none{background:transparent}

/* LEGEND */
.legend{display:-webkit-flex;display:flex;-webkit-flex-wrap:wrap;flex-wrap:wrap;gap:10px;padding:12px 16px;-webkit-justify-content:center;justify-content:center}
.legend span{display:-webkit-flex;display:flex;-webkit-align-items:center;align-items:center;gap:4px;font-size:11px;color:var(--text2)}
.legend .lsq{width:14px;height:14px;border-radius:3px;display:inline-block}

/* MODAL */
.ov{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(44,74,124,0.4);z-index:100;display:none;-webkit-align-items:flex-end;align-items:flex-end;-webkit-justify-content:center;justify-content:center}
.ov.op{display:-webkit-flex;display:flex}
.md{background:#fff;border-radius:20px 20px 0 0;width:100%;max-width:500px;max-height:90vh;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:0 0 32px;box-shadow:0 -4px 30px rgba(0,0,0,0.15)}
.md-handle{display:-webkit-flex;display:flex;-webkit-justify-content:center;justify-content:center;padding:10px 0 6px}
.md-handle div{width:40px;height:4px;border-radius:2px;background:#D4DBE8}
.md-header{padding:8px 20px 16px;border-bottom:1px solid var(--border)}
.md-header h3{font-size:20px;font-weight:700;color:var(--blue)}
.md-header p{font-size:13px;color:var(--text2);margin-top:2px}

.form-section{padding:16px 20px 8px}
.form-label{font-size:14px;font-weight:700;color:var(--text);margin-bottom:4px}
.form-hint{font-size:12px;color:var(--text2);margin-bottom:10px}

/* Cycle day + date row */
.cycle-row{display:-webkit-flex;display:flex;gap:10px;margin-bottom:0}
.cycle-counter{display:-webkit-flex;display:flex;-webkit-align-items:center;align-items:center;border:1px solid var(--border);border-radius:12px;overflow:hidden}
.cycle-counter button{width:36px;height:44px;border:none;background:var(--blue-light);color:var(--blue);font-size:18px;font-weight:700}
.cycle-counter .cv{width:36px;text-align:center;font-size:16px;font-weight:700;color:var(--text)}
.date-display{-webkit-flex:1;flex:1;border:1px solid var(--border);border-radius:12px;padding:10px 14px;font-size:15px;font-weight:600;color:var(--text);display:-webkit-flex;display:flex;-webkit-align-items:center;align-items:center;-webkit-justify-content:center;justify-content:center}

/* Select fields */
.form-select{width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:12px;font-size:14px;color:var(--text);background:#fff url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%2364748B' stroke-width='2' fill='none'/%3E%3C/svg%3E") no-repeat right 14px center;background-size:12px;padding-right:36px;margin-bottom:4px}

/* STAMPS GRID */
.stamps-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
.stamp-btn{width:100%;aspect-ratio:1;border-radius:10px;border:3px solid transparent;display:-webkit-flex;display:flex;-webkit-flex-direction:column;flex-direction:column;-webkit-align-items:center;align-items:center;-webkit-justify-content:center;justify-content:center;font-size:11px;font-weight:800;color:#fff;gap:1px;transition:all 0.15s;position:relative}
.stamp-btn.on{border-color:var(--blue);box-shadow:0 0 0 2px var(--blue)}
.stamp-btn .stxt{font-size:8px;font-weight:600;color:#fff;opacity:0.9}
.stamp-btn.swhite{color:#666}
.stamp-btn.swhite .stxt{color:#999}

/* Notes */
.form-notes{width:100%;min-height:70px;border-radius:12px;border:1px solid var(--border);padding:12px 14px;font-size:14px;color:var(--text);background:#fff;resize:vertical;outline:none}
.form-notes:focus{border-color:var(--blue)}

/* Checkboxes */
.check-wrap{display:-webkit-flex;display:flex;gap:8px;-webkit-flex-wrap:wrap;flex-wrap:wrap}
.check-btn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#fff;display:-webkit-flex;display:flex;-webkit-align-items:center;align-items:center;gap:6px;font-size:13px;font-weight:600;color:var(--text2)}
.check-btn.on{border-color:var(--blue);background:var(--blue-light);color:var(--blue)}

/* Done button */
.done-btn{width:100%;padding:16px;border-radius:14px;border:none;background:var(--blue);color:#fff;font-size:16px;font-weight:700;box-shadow:0 4px 16px rgba(44,74,124,0.3);margin-top:8px}

/* Chart */
.chart-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:8px}
.chart-inner{display:-webkit-flex;display:flex;gap:2px}
.chart-col{display:-webkit-flex;display:flex;-webkit-flex-direction:column;flex-direction:column;-webkit-align-items:center;align-items:center;width:22px;-webkit-flex-shrink:0;flex-shrink:0;cursor:pointer}
.chart-stamp{width:18px;height:18px;border-radius:3px;margin-bottom:3px}
.chart-day{font-size:8px;font-weight:600;color:var(--text2)}
.chart-day.tm{font-weight:800;color:var(--blue)}

.stats-grid{margin-top:16px;display:grid;grid-template-columns:1fr 1fr;gap:10px}
.stat-card{background:#fff;border-radius:14px;padding:14px 16px;border:1px solid var(--border)}
.stat-card .si{font-size:20px;margin-bottom:4px}
.stat-card .sv{font-size:22px;font-weight:800;color:var(--blue)}
.stat-card .sla{font-size:11px;color:var(--text2);font-weight:600}

/* Data bar */
.data-bar{padding:12px 16px;display:-webkit-flex;display:flex;gap:8px;-webkit-flex-wrap:wrap;flex-wrap:wrap}
.data-btn{padding:10px 16px;border-radius:10px;border:1px solid var(--border);background:#fff;font-size:13px;font-weight:600;color:var(--text2)}
.data-btn:active{background:var(--blue-light);border-color:var(--blue)}

/* Bottom nav */
.bot-nav{position:fixed;bottom:0;left:0;right:0;max-width:500px;margin:0 auto;background:#fff;border-top:1px solid var(--border);display:-webkit-flex;display:flex;z-index:10;padding-bottom:env(safe-area-inset-bottom,0)}
.bot-nav button{-webkit-flex:1;flex:1;padding:8px 0 6px;border:none;background:none;display:-webkit-flex;display:flex;-webkit-flex-direction:column;flex-direction:column;-webkit-align-items:center;align-items:center;gap:2px;font-size:10px;font-weight:600;color:var(--text2)}
.bot-nav button.on{color:var(--blue)}
.bot-nav .bn-icon{font-size:22px}

.spacer{height:80px}

/* Fallback */
.warn-box{margin:16px;padding:16px 20px;background:#FFF3CD;border:2px solid #FFDB7E;border-radius:14px;text-align:center}
.warn-box p{font-size:14px;font-weight:600;color:#856404;margin-bottom:4px}
.warn-box small{font-size:12px;color:#997A1E}
</style>
</head>
<body>

<!-- FALLBACK for non-JS viewers -->
<div id="fallback">
  <div class="warn-box">
    <p>&#9888;&#65039; Abra no navegador para funcionar!</p>
    <small>Este preview n&#227;o executa o app. Toque em "Compartilhar" e depois "Abrir no Safari" ou Chrome.</small>
  </div>
</div>

<div id="appRoot" style="display:none">
  <div class="navbar">
    <h1>&#127804; Meu Ciclo</h1>
    <div class="nav-right">
      <button class="nav-icon" id="expBtn2" title="Exportar">&#128228;</button>
      <button class="nav-icon" id="impBtn2" title="Importar">&#128229;</button>
      <input type="file" id="impF" accept=".json" style="display:none">
    </div>
  </div>

  <div class="tabs">
    <button class="tab on" id="tab0">&#127968; In&#237;cio</button>
    <button class="tab" id="tab1">&#128197; Calend&#225;rio</button>
    <button class="tab" id="tab2">&#128202; Gr&#225;fico</button>
  </div>

  <div id="app"></div>
  <div class="spacer"></div>

  <div class="bot-nav">
    <button class="on" id="bn0"><span class="bn-icon">&#127968;</span>In&#237;cio</button>
    <button id="bn1"><span class="bn-icon">&#128197;</span>Calend&#225;rio</button>
    <button id="bn2"><span class="bn-icon">&#10133;</span>Anotar</button>
    <button id="bn3"><span class="bn-icon">&#128202;</span>Gr&#225;fico</button>
  </div>
</div>

<div class="ov" id="ov"><div class="md" id="md"></div></div>

<script>
;(function(){
"use strict";

document.getElementById("fallback").style.display="none";
document.getElementById("appRoot").style.display="block";

var MO=["Janeiro","Fevereiro","Mar\u00e7o","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
var WD=["Dom","Seg","Ter","Qua","Qui","Sex","S\u00e1b"];

// Stamps: id, label, color class, short text, bg color
var STAMPS=[
  {id:"red",l:"Sangramento",cls:"bg-red",bg:"#E53935",tx:""},
  {id:"red-spot",l:"Sangramento leve",cls:"bg-red2",bg:"#EF5350",tx:"\u2022"},
  {id:"dry",l:"Seco",cls:"bg-white",bg:"#ECEFF1",tx:"",fc:"#666"},
  {id:"moist-y",l:"Pegajoso",cls:"bg-yellow",bg:"#FFC107",tx:""},
  {id:"moist-y2",l:"Pegajoso (mudando)",cls:"bg-yellow2",bg:"#FFD54F",tx:""},
  {id:"wet",l:"Molhado / El\u00e1stico",cls:"bg-green",bg:"#4CAF50",tx:""},
  {id:"wet2",l:"Muito molhado",cls:"bg-green2",bg:"#388E3C",tx:""},
  {id:"peak",l:"\u00c1pice (Peak)",cls:"bg-green-peak",bg:"#2E7D32",tx:"\u2605"},
  {id:"post1",l:"P\u00f3s-\u00c1pice 1",cls:"bg-green3",bg:"#66BB6A",tx:"1"},
  {id:"post2",l:"P\u00f3s-\u00c1pice 2",cls:"bg-green4",bg:"#81C784",tx:"2"},
  {id:"post3",l:"P\u00f3s-\u00c1pice 3",cls:"bg-green5",bg:"#A5D6A7",tx:"3"},
  {id:"infertile",l:"Inf\u00e9rtil confirmado",cls:"bg-yellow3",bg:"#FFB300",tx:"\u2713"}
];

var SENSATIONS=[
  "Nada especial","Seca","Levemente \u00famida","Molhada","Escorregadia / Lubrificada"
];
var OBSERVATIONS=[
  "Nada vis\u00edvel","Pegajoso, opaco, branco","Cremoso, leitoso","Transparente, el\u00e1stico","Sangue / manchas"
];

var E={},now=new Date(),vM=now.getMonth(),vY=now.getFullYear(),vw="home",oK=null;
var canStore=false;
try{localStorage.setItem("_t","1");localStorage.removeItem("_t");canStore=true;}catch(e){}

function p2(x){return x<10?"0"+x:""+x;}
function mk(y,m,d){return y+"-"+p2(m+1)+"-"+p2(d);}
function tk(){var t=new Date();return mk(t.getFullYear(),t.getMonth(),t.getDate());}
function kd(k){var s=k.split("-");return new Date(parseInt(s[0],10),parseInt(s[1],10)-1,parseInt(s[2],10));}
function fs(k){var x=E[k];if(!x||!x.stamp)return null;for(var j=0;j<STAMPS.length;j++){if(STAMPS[j].id===x.stamp)return STAMPS[j];}return null;}
function bind(el,ev,fn){if(el&&el.addEventListener)el.addEventListener(ev,fn,false);}
function ld(){if(!canStore)return;try{var r=localStorage.getItem("mob5");if(r)E=JSON.parse(r);}catch(e){E={};}}
function sv(){if(!canStore)return;try{localStorage.setItem("mob5",JSON.stringify(E));}catch(e){}}

var app=document.getElementById("app");
var ov=document.getElementById("ov");
var mdEl=document.getElementById("md");
var tabs=[document.getElementById("tab0"),document.getElementById("tab1"),document.getElementById("tab2")];
var bns=[document.getElementById("bn0"),document.getElementById("bn1"),null,document.getElementById("bn3")];

function setView(v){
  vw=v;
  var idx=v==="home"?0:v==="cal"?1:2;
  for(var i=0;i<tabs.length;i++){tabs[i].className="tab"+(i===idx?" on":"");}
  for(var i=0;i<bns.length;i++){if(bns[i])bns[i].className=(i===idx?"on":"");}
  dr();
}
bind(tabs[0],"click",function(){setView("home");});
bind(tabs[1],"click",function(){setView("cal");});
bind(tabs[2],"click",function(){setView("chart");});
bind(bns[0],"click",function(){setView("home");});
bind(bns[1],"click",function(){setView("cal");});
bind(document.getElementById("bn2"),"click",function(){om(tk());});
bind(bns[3],"click",function(){setView("chart");});

bind(ov,"click",function(ev){if(ev.target===ov)cm();});

bind(document.getElementById("expBtn2"),"click",function(){
  var bl=new Blob([JSON.stringify(E,null,2)],{type:"application/json"});
  var a=document.createElement("a");a.href=URL.createObjectURL(bl);a.download="meu-ciclo-backup.json";
  document.body.appendChild(a);a.click();document.body.removeChild(a);
});
bind(document.getElementById("impBtn2"),"click",function(){document.getElementById("impF").click();});
bind(document.getElementById("impF"),"change",function(ev){
  var f=ev.target.files[0];if(!f)return;
  var rd=new FileReader();
  rd.onload=function(e2){try{var d=JSON.parse(e2.target.result);var ks=Object.keys(d);for(var j=0;j<ks.length;j++)E[ks[j]]=d[ks[j]];sv();dr();alert("Dados importados!");}catch(er){alert("Erro ao importar.");}};
  rd.readAsText(f);ev.target.value="";
});

function getCycleDay(key){
  // Count back to find last bleeding start
  var d=kd(key);var count=1;
  for(var i=1;i<90;i++){
    var prev=new Date(d.getTime());prev.setDate(prev.getDate()-i);
    var pk=mk(prev.getFullYear(),prev.getMonth(),prev.getDate());
    var pe=E[pk];
    if(pe&&(pe.stamp==="red"||pe.stamp==="red-spot")){
      // check if day before this is NOT bleeding (this is the start)
      var prev2=new Date(prev.getTime());prev2.setDate(prev2.getDate()-1);
      var pk2=mk(prev2.getFullYear(),prev2.getMonth(),prev2.getDate());
      var pe2=E[pk2];
      if(!pe2||!(pe2.stamp==="red"||pe2.stamp==="red-spot")){
        count=i+1;break;
      }
    }
    if(!pe)continue;
  }
  return count;
}

// HOME VIEW
function drawHome(){
  var tK=tk();var en=E[tK];var st=en?fs(tK):null;
  var cd=en?getCycleDay(tK):"--";

  var h='<div class="home-card" id="hcard"><div class="hc-text"><h2>Nova anota\u00e7\u00e3o di\u00e1ria</h2><p>Registre como se sente hoje</p></div><button class="hc-btn" id="hcbtn">+</button></div>';

  h+='<div class="info-row"><div class="dot" style="background:var(--green)"></div><span class="ir-label">Ciclo Atual</span><span class="ir-val">Dia '+cd+'</span></div>';

  if(st){
    h+='<div class="info-row"><div class="dot" style="background:'+st.bg+'"></div><span class="ir-label">Hoje</span><span class="ir-val">'+st.l+'</span></div>';
  }

  // Recent entries
  var recent=[];var td=new Date();
  for(var i=0;i<7;i++){
    var dd=new Date(td.getTime());dd.setDate(dd.getDate()-i);
    var k=mk(dd.getFullYear(),dd.getMonth(),dd.getDate());
    if(E[k])recent.push({k:k,d:dd,e:E[k]});
  }
  if(recent.length>0){
    h+='<div style="padding:16px 16px 4px"><span style="font-size:14px;font-weight:700;color:var(--blue)">\u00daltimas anota\u00e7\u00f5es</span></div>';
    for(var i=0;i<recent.length&&i<5;i++){
      var r=recent[i];var s=fs(r.k);
      var dayStr=r.d.getDate()+"/"+p2(r.d.getMonth()+1);
      h+='<div class="info-row" data-k="'+r.k+'" style="cursor:pointer"><div style="width:24px;height:24px;border-radius:5px;background:'+(s?s.bg:"#eee")+';display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:800;color:#fff;flex-shrink:0">'+(s&&s.tx?s.tx:"")+'</div><span class="ir-label" style="font-size:13px">'+dayStr+' - '+WD[r.d.getDay()]+'</span><span class="ir-val">'+(s?s.l:"")+'</span></div>';
    }
  }

  app.innerHTML=h;
  bind(document.getElementById("hcbtn"),"click",function(){om(tK);});
  bind(document.getElementById("hcard"),"click",function(){om(tK);});
  var rows=app.querySelectorAll("[data-k]");
  for(var j=0;j<rows.length;j++){(function(el){bind(el,"click",function(){om(el.getAttribute("data-k"));});})(rows[j]);}
}

// CALENDAR VIEW
function drawCal(){
  var dm=new Date(vY,vM+1,0).getDate();
  var fw=new Date(vY,vM,1).getDay();
  var tK=tk();
  var h='<div class="cal-wrap">';
  h+='<div class="mnav"><button class="nbtn" id="pv">\u2039</button><h2>'+MO[vM]+' '+vY+'</h2><button class="nbtn" id="nx">\u203A</button></div>';
  h+='<div class="wk">';for(var w=0;w<7;w++)h+='<span>'+WD[w]+'</span>';h+='</div>';
  h+='<div class="cg">';
  for(var j=0;j<fw;j++)h+='<div></div>';
  for(var d=1;d<=dm;d++){
    var k=mk(vY,vM,d);var st=fs(k);var iT=(k===tK);
    h+='<button class="cc'+(iT?" today-c":"")+'" data-k="'+k+'">';
    h+='<span class="day-num">'+d+'</span>';
    if(st){
      var fc=st.fc||"#fff";
      h+='<div class="stamp" style="background:'+st.bg+';color:'+fc+'">'+st.tx+'</div>';
    }
    h+='</button>';
  }
  h+='</div>';
  h+='<div class="legend">';
  var legs=[{c:"#E53935",l:"Sangramento"},{c:"#ECEFF1",l:"Seco",brd:true},{c:"#FFC107",l:"Pegajoso"},{c:"#4CAF50",l:"Molhado/F\u00e9rtil"},{c:"#2E7D32",l:"\u00c1pice"},{c:"#FFB300",l:"Inf\u00e9rtil"}];
  for(var j=0;j<legs.length;j++){
    var brd=legs[j].brd?";border:1px solid #ccc":"";
    h+='<span><span class="lsq" style="background:'+legs[j].c+brd+'"></span>'+legs[j].l+'</span>';
  }
  h+='</div></div>';
  app.innerHTML=h;
  bind(document.getElementById("pv"),"click",function(){vM--;if(vM<0){vM=11;vY--;}dr();});
  bind(document.getElementById("nx"),"click",function(){vM++;if(vM>11){vM=0;vY++;}dr();});
  var cells=app.querySelectorAll(".cc");
  for(var j=0;j<cells.length;j++){(function(el){bind(el,"click",function(){om(el.getAttribute("data-k"));});})(cells[j]);}
}

// CHART VIEW
function drawChart(){
  var td=new Date();td.setHours(0,0,0,0);var tK=tk();
  var h='<div style="padding:12px 16px"><p style="font-size:14px;color:var(--blue);font-weight:700;margin-bottom:12px">\u00daltimos 40 dias</p>';
  h+='<div class="chart-scroll"><div class="chart-inner">';
  for(var i=39;i>=0;i--){
    var dd=new Date(td.getTime());dd.setDate(dd.getDate()-i);
    var k=mk(dd.getFullYear(),dd.getMonth(),dd.getDate());
    var st=fs(k);var iT=(k===tK);var bg=st?st.bg:"#E8E8E8";
    h+='<div class="chart-col" data-k="'+k+'">';
    h+='<div class="chart-stamp" style="background:'+bg+'"></div>';
    h+='<span class="chart-day'+(iT?" tm":"")+'">'+dd.getDate()+'</span>';
    h+='</div>';
  }
  h+='</div></div>';
  var aK=Object.keys(E).sort();var bl=0,fe=0,tot=aK.length;
  for(var j=0;j<aK.length;j++){var m=E[aK[j]].stamp;if(m==="red"||m==="red-spot")bl++;if(m==="wet"||m==="wet2"||m==="peak")fe++;}
  var cl2="\u2014";var starts=[];
  for(var j=0;j<aK.length;j++){if(E[aK[j]].stamp==="red"||E[aK[j]].stamp==="red-spot"){if(j===0||!(E[aK[j-1]]&&(E[aK[j-1]].stamp==="red"||E[aK[j-1]].stamp==="red-spot")))starts.push(aK[j]);}}
  if(starts.length>=2){var la=kd(starts[starts.length-1]);var pr=kd(starts[starts.length-2]);cl2=Math.round((la-pr)/86400000);}
  var ss=[{ic:"\uD83D\uDCDD",v:tot,lb:"Registros"},{ic:"\uD83D\uDD04",v:cl2,lb:"Ciclo (dias)"},{ic:"\uD83C\uDF3A",v:fe,lb:"Dias f\u00e9rteis"},{ic:"\uD83D\uDD34",v:bl,lb:"Dias sangram."}];
  h+='<div class="stats-grid">';for(var j=0;j<ss.length;j++)h+='<div class="stat-card"><div class="si">'+ss[j].ic+'</div><div class="sv">'+ss[j].v+'</div><div class="sla">'+ss[j].lb+'</div></div>';h+='</div>';
  h+='</div>';
  app.innerHTML=h;
  var cols=app.querySelectorAll(".chart-col");
  for(var j=0;j<cols.length;j++){(function(el){bind(el,"click",function(){om(el.getAttribute("data-k"));});})(cols[j]);}
}

function dr(){if(vw==="home")drawHome();else if(vw==="cal")drawCal();else drawChart();}

// MODAL
function om(k){
  oK=k;var d=kd(k);var en=E[k]||{};
  var cd=en.cycleDay||getCycleDay(k);
  var dateStr=d.getDate()+"/"+p2(d.getMonth()+1)+"/"+d.getFullYear();

  var h='<div class="md-handle"><div></div></div>';
  h+='<div class="md-header"><h3>Nova Anota\u00e7\u00e3o</h3><p>'+WD[d.getDay()]+', '+dateStr+'</p></div>';

  // Cycle day + date
  h+='<div class="form-section"><div class="form-label">Dia do ciclo e data</div><div class="form-hint">Registre o dia do ciclo</div>';
  h+='<div class="cycle-row"><div class="cycle-counter"><button id="cdMinus">\u2212</button><span class="cv" id="cdVal">'+cd+'</span><button id="cdPlus">+</button></div>';
  h+='<div class="date-display">'+dateStr+'</div></div></div>';

  // Sensation
  h+='<div class="form-section"><div class="form-label">O que eu sinto</div><div class="form-hint">Descreva a SENSA\u00c7\u00c3O em seu genital externo</div>';
  h+='<select class="form-select" id="selSens"><option value="">Selecione...</option>';
  for(var j=0;j<SENSATIONS.length;j++){var sel=(en.sensation===SENSATIONS[j])?" selected":"";h+='<option value="'+SENSATIONS[j]+'"'+sel+'>'+SENSATIONS[j]+'</option>';}
  h+='</select></div>';

  // Observation
  h+='<div class="form-section"><div class="form-label">O que eu vejo</div><div class="form-hint">O que voc\u00ea observa na roupa \u00edntima ou ao usar o banheiro</div>';
  h+='<select class="form-select" id="selObs"><option value="">Selecione...</option>';
  for(var j=0;j<OBSERVATIONS.length;j++){var sel=(en.observation===OBSERVATIONS[j])?" selected":"";h+='<option value="'+OBSERVATIONS[j]+'"'+sel+'>'+OBSERVATIONS[j]+'</option>';}
  h+='</select></div>';

  // Stamps
  h+='<div class="form-section"><div class="form-label">Selecione o Selo/S\u00edmbolo</div><div class="form-hint">Conforme o M\u00e9todo de Ovula\u00e7\u00e3o Billings</div>';
  h+='<div class="stamps-grid">';
  for(var j=0;j<STAMPS.length;j++){
    var s=STAMPS[j];var a=(en.stamp===s.id);
    var fc=s.fc||"#fff";var wc=s.fc?"swhite":"";
    h+='<button class="stamp-btn '+wc+(a?" on":"")+'" style="background:'+s.bg+';color:'+fc+'" data-st="'+s.id+'">';
    if(s.tx)h+='<span>'+s.tx+'</span>';
    h+='<span class="stxt">'+s.l.split(" ")[0]+'</span>';
    h+='</button>';
  }
  h+='</div></div>';

  // Extras
  h+='<div class="form-section"><div class="form-label">Extras</div><div class="check-wrap">';
  var extras=[{i:"intercourse",l:"Rela\u00e7\u00e3o",e:"\uD83D\uDC91"},{i:"pain",l:"C\u00f3lica",e:"\uD83D\uDE23"},{i:"breast",l:"Seios",e:"\uD83E\uDD31"},{i:"mood",l:"Humor",e:"\uD83D\uDE0A"}];
  for(var j=0;j<extras.length;j++){var x=extras[j];var a2=!!en[x.i];h+='<button class="check-btn'+(a2?" on":"")+'" data-ex="'+x.i+'">'+x.e+' '+x.l+'</button>';}
  h+='</div></div>';

  // Notes
  h+='<div class="form-section"><div class="form-label">Outras observa\u00e7\u00f5es</div>';
  h+='<textarea class="form-notes" id="nf" placeholder="Observa\u00e7\u00f5es...">'+(en.notes||'')+'</textarea></div>';

  h+='<div style="padding:0 20px"><button class="done-btn" id="done">Salvar Anota\u00e7\u00e3o \u2713</button></div>';

  mdEl.innerHTML=h;
  ov.className="ov op";

  // Cycle day controls
  var cdv=cd;
  bind(document.getElementById("cdMinus"),"click",function(ev){ev.stopPropagation();if(cdv>1)cdv--;document.getElementById("cdVal").textContent=cdv;});
  bind(document.getElementById("cdPlus"),"click",function(ev){ev.stopPropagation();cdv++;document.getElementById("cdVal").textContent=cdv;});

  bind(document.getElementById("done"),"click",function(){saveFull(cdv);});

  // Stamp buttons
  var stbs=mdEl.querySelectorAll("[data-st]");
  for(var j=0;j<stbs.length;j++){(function(el){bind(el,"click",function(){
    var id=el.getAttribute("data-st");
    if(!E[oK])E[oK]={date:oK};
    if(E[oK].stamp===id)delete E[oK].stamp;else E[oK].stamp=id;
    ce(oK);sv();om(oK);
  });})(stbs[j]);}

  // Extra buttons
  var exbs=mdEl.querySelectorAll("[data-ex]");
  for(var j=0;j<exbs.length;j++){(function(el){bind(el,"click",function(){
    var id=el.getAttribute("data-ex");
    if(!E[oK])E[oK]={date:oK};
    if(E[oK][id])delete E[oK][id];else E[oK][id]=true;
    ce(oK);sv();om(oK);
  });})(exbs[j]);}
}

function saveFull(cdv){
  if(!oK)return;
  if(!E[oK])E[oK]={date:oK};
  E[oK].cycleDay=cdv;
  var sens=document.getElementById("selSens");if(sens&&sens.value)E[oK].sensation=sens.value;else if(E[oK])delete E[oK].sensation;
  var obs=document.getElementById("selObs");if(obs&&obs.value)E[oK].observation=obs.value;else if(E[oK])delete E[oK].observation;
  var ta=document.getElementById("nf");if(ta){var v=ta.value.trim();if(v)E[oK].notes=v;else delete E[oK].notes;}
  ce(oK);sv();cm();
}

function cm(){
  ov.className="ov";oK=null;dr();
}

function ce(k){
  if(!E[k])return;var x=E[k];
  var has=x.stamp||x.sensation||x.observation||x.notes||x.cycleDay;
  if(!has){var extras=["intercourse","pain","breast","mood"];for(var j=0;j<extras.length;j++){if(x[extras[j]]){has=true;break;}}}
  if(!has)delete E[k];
}

ld();dr();
})();
</script>
</body>
</html>
